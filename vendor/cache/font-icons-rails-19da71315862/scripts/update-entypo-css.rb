require 'net/http'

page_content = Net::HTTP.get(URI.parse 'http://www.entypo.com/characters.php')
base_icons_content, social_icons_content, *ignore = page_content.split('<h3>The Entypo Social Extention</h3>')
markers = ["\n/*autogenerated:BEGIN*/\n", "\n/*autogenerated:END*/\n"]

{
    '_font-icons-entypo'=> base_icons_content,
    '_font-icons-entypo-social'=> social_icons_content
}.each do |set_name, content|
  base_css = File.join( File.dirname( __FILE__ ), '..', 'vendor/assets/stylesheets', set_name + '.scss' )
  ie7_css = File.join( File.dirname( __FILE__ ), '..', 'vendor/assets/stylesheets', set_name + '-ie7.css' )

  icons = content.gsub("\n",'').gsub("\t",'').scan(/<li title="([a-z0-9\-]+)".*?>.+?U\+([A-Z0-9]+).+?<\/li>/im)

  payload = icons.map do |name, code|
    ".icon-et#{'s' if set_name.match(/social/i)}-#{name}:before".ljust(44) + "{ content: \"\\\\#{code.downcase}\"; }"
  end.join("\n")
  data = File.read(base_css).gsub(/#{Regexp.escape markers[0]}.+?#{Regexp.escape markers[1]}/im, markers[0] + payload + markers[1] )
  File.open(base_css, 'w'){ |f| f.write data }
  print data

  payload = icons.map do |name, code|
    ".icon-et#{'s' if set_name.match(/social/)}-#{name}".ljust(32) + "{ *zoom: expression( this.runtimeStyle['zoom'] = \"1\", this.innerHTML = '&#x#{code.downcase};&nbsp;'); }"
  end.join("\n")
  data = File.read(ie7_css).gsub(/#{Regexp.escape markers[0]}.+?#{Regexp.escape markers[1]}/im, markers[0] + payload + markers[1] )
  File.open(ie7_css, 'w'){ |f| f.write data }
end
